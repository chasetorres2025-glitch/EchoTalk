## 实时对话模式开发计划

### 核心需求
- 进入聊天界面后，用户可以随时说话
- AI自动识别语音并实时回复
- 支持打断：用户说话时自动停止AI播放
- 类似打电话的自然对话体验

---

### 实现方案

#### 1. 前端（微信小程序）

**1.1 聊天页面改造**
- 使用 `wx.getRecorderManager()` 的 `onFrameRecorded` 实时获取音频帧
- 使用 `wx.connectSocket()` 建立WebSocket长连接
- 实现VAD（语音活动检测）：检测用户是否在说话
- 打断机制：用户说话时自动停止AI语音播放
- 保留"按住说话"作为备选模式

**1.2 UI改造**
- 实时对话模式：显示"正在聆听..."状态
- 用户说话时显示音量波形动画
- AI回复时显示"AI正在回复..."

#### 2. 后端（Flask服务器）

**2.1 添加WebSocket支持**
- 安装 `flask-socketio` + `python-socketio`
- 创建WebSocket路由处理实时音频流

**2.2 实时语音识别**
- 使用阿里云百炼实时ASR（paraformer-realtime-v2）
- 流式接收音频，实时返回识别文字

**2.3 流式语音合成**
- 使用流式TTS，边生成边返回音频

---

### 文件修改清单

| 文件 | 操作 | 说明 |
|------|------|------|
| `client/pages/chat/chat.js` | 修改 | 实现实时对话逻辑 |
| `client/pages/chat/chat.wxml` | 修改 | 实时对话UI |
| `client/pages/chat/chat.wxss` | 修改 | 实时对话样式 |
| `client/utils/api.js` | 修改 | WebSocket连接封装 |
| `server/requirements.txt` | 修改 | 添加依赖 |
| `server/app/__init__.py` | 修改 | 初始化SocketIO |
| `server/app/routes/realtime.py` | 新增 | 实时语音处理路由 |
| `server/app/utils/bailian_client.py` | 修改 | 添加实时ASR方法 |

---

### 技术要点

1. **微信小程序实时录音**：`onFrameRecorded` 获取PCM帧
2. **WebSocket**：`wx.connectSocket` + `flask-socketio`
3. **打断检测**：监听音量，超过阈值停止AI播放
4. **阿里云实时ASR**：流式识别，实时返回结果