# 优化后的部署方案

## 现状分析

### 服务器现状
- **内存**: 1.7GB 可用（已有其他服务在运行）
- **MySQL**: 8.0.44 已安装 ✓
- **Nginx**: 1.20.1 已安装 ✓
- **Python**: 2.7.5 / 3.6.8（需要升级）

### 客户端/服务端分离建议

根据行业标准，**微信小程序客户端和服务端应该分离部署**：

| 类型 | 部署位置 | 说明 |
|------|----------|------|
| **客户端** | 微信小程序平台 | 用户通过微信扫码直接使用，无需部署 |
| **服务端** | 阿里云服务器 | API服务、数据库、文件存储 |

**分离优势**:
1. 客户端零部署成本，自动更新
2. 服务端集中管理，安全可控
3. 符合微信小程序架构设计

---

## 优化后的部署步骤

### 第一步：精简部署脚本（跳过已安装服务）

创建新的轻量级部署脚本 `deploy-lite.sh`：

```bash
#!/bin/bash
# EchoTalk 轻量级部署脚本（适用于已有 MySQL/Nginx 的环境）

set -e

echo "=========================================="
echo "  EchoTalk 轻量级部署脚本"
echo "=========================================="

# 配置
PROJECT_DIR="/opt/echotalk"
DB_NAME="echotalk"
DB_USER="echotalk"
DB_PASSWORD="$(openssl rand -base64 16)"

# 1. 检查并安装 Python 3.9（如果未安装）
if ! command -v python3.9 &> /dev/null; then
    echo "[1/6] 安装 Python 3.9..."
    yum install -y gcc openssl-devel bzip2-devel libffi-devel zlib-devel wget
    cd /tmp
    wget -q "https://www.python.org/ftp/python/3.9.18/Python-3.9.18.tgz"
    tar xzf Python-3.9.18.tgz
    cd Python-3.9.18
    ./configure --enable-optimizations --prefix=/usr/local
    make -j$(nproc)
    make altinstall
    rm -rf /tmp/Python-3.9.18*
else
    echo "[1/6] Python 3.9 已存在"
fi

# 2. 检查并安装 MongoDB（如果未安装）
if ! command -v mongod &> /dev/null; then
    echo "[2/6] 安装 MongoDB 4.4..."
    cat > /etc/yum.repos.d/mongodb-org-4.4.repo <<EOF
[mongodb-org-4.4]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/\$releasever/mongodb-org/4.4/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-4.4.asc
EOF
    yum install -y mongodb-org
    systemctl start mongod
    systemctl enable mongod
else
    echo "[2/6] MongoDB 已存在"
fi

# 3. 创建数据库
echo "[3/6] 创建 MySQL 数据库..."
mysql -u root -e "CREATE DATABASE IF NOT EXISTS ${DB_NAME} CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" 2>/dev/null || true
mysql -u root -e "CREATE USER IF NOT EXISTS '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASSWORD}';" 2>/dev/null || true
mysql -u root -e "GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'localhost';" 2>/dev/null || true
mysql -u root -e "FLUSH PRIVILEGES;" 2>/dev/null || true

# 4. 部署项目代码
echo "[4/6] 部署项目代码..."
mkdir -p ${PROJECT_DIR}
if [ -d "/root/EchoTalk" ]; then
    cp -r /root/EchoTalk/server/* ${PROJECT_DIR}/
fi
mkdir -p ${PROJECT_DIR}/logs ${PROJECT_DIR}/uploads

# 5. 配置 Python 环境
echo "[5/6] 配置 Python 虚拟环境..."
cd ${PROJECT_DIR}
python3.9 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
pip install gunicorn

# 6. 初始化配置
echo "[6/6] 初始化配置..."
cat > ${PROJECT_DIR}/.env <<EOF
SECRET_KEY=$(openssl rand -hex 32)
MYSQL_PASSWORD=${DB_PASSWORD}
WECHAT_APPID=your-wechat-appid
WECHAT_SECRET=your-wechat-secret
ALIYUN_API_KEY=your-aliyun-api-key
EOF

# 修改 config.ini
sed -i 's/^debug = true/debug = false/' ${PROJECT_DIR}/config.ini
sed -i 's/^host = localhost/host = 127.0.0.1/' ${PROJECT_DIR}/config.ini
sed -i 's/^user = root/user = echotalk/' ${PROJECT_DIR}/config.ini
sed -i 's/^flask_env = development/flask_env = production/' ${PROJECT_DIR}/config.ini

# 初始化数据库表
python init_db.py

# 创建 Systemd 服务
cat > /etc/systemd/system/echotalk.service <<EOF
[Unit]
Description=EchoTalk Flask Application
After=network.target mysqld.service mongod.service

[Service]
Type=simple
User=root
WorkingDirectory=${PROJECT_DIR}
Environment="PATH=${PROJECT_DIR}/venv/bin"
Environment="FLASK_ENV=production"
ExecStart=${PROJECT_DIR}/venv/bin/gunicorn -w 2 -b 127.0.0.1:5050 --access-logfile logs/access.log --error-logfile logs/error.log "app:create_app()"
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable echotalk

# 配置 Nginx
cat > /etc/nginx/conf.d/echotalk.conf <<EOF
server {
    listen 80;
    server_name _;

    access_log /var/log/nginx/echotalk-access.log;
    error_log /var/log/nginx/echotalk-error.log;

    client_max_body_size 16M;

    location / {
        proxy_pass http://127.0.0.1:5050;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    location /uploads {
        alias ${PROJECT_DIR}/uploads;
        expires 30d;
    }
}
EOF

nginx -t
systemctl reload nginx
systemctl start echotalk

echo ""
echo "=========================================="
echo "部署完成!"
echo "=========================================="
echo ""
echo "数据库名: ${DB_NAME}"
echo "数据库用户: ${DB_USER}"
echo "数据库密码: ${DB_PASSWORD}"
echo ""
echo "请修改 ${PROJECT_DIR}/.env 文件配置真实密钥"
echo "然后执行: systemctl restart echotalk"
```

### 第二步：修改小程序客户端配置

修改 `client/app.js` 中的 `baseUrl` 为服务器地址：

```javascript
App({
  globalData: {
    userInfo: null,
    openId: null,
    // 开发环境
    // baseUrl: 'http://localhost:5050'
    // 生产环境（部署后修改为你的服务器地址）
    baseUrl: 'https://your-domain.com'  // 或 http://你的服务器IP
  },
  // ...
})
```

### 第三步：微信小程序配置

在微信公众平台配置服务器域名：
1. 登录 [微信公众平台](https://mp.weixin.qq.com)
2. 开发 → 开发管理 → 开发设置 → 服务器域名
3. 添加 request 合法域名：`https://your-domain.com`
4. 添加 uploadFile 合法域名（用于语音上传）

---

## 关键优化点

### 1. 内存优化（1.7GB 可用）

- **Gunicorn 工作进程**: 从 4 个减少到 **2 个**（节省内存）
- **不配置 Swap**: 已有其他服务，避免影响
- **精简依赖**: 只安装必要服务

### 2. 使用现有服务

- **MySQL 8.0**: 直接使用已安装的 MySQL 8.0（兼容性好）
- **Nginx 1.20**: 直接使用已安装的 Nginx
- **跳过重复安装**: 避免冲突

### 3. 部署结构

```
阿里云服务器
├── Nginx (已存在) ← 反向代理到 Flask
├── MySQL 8.0 (已存在) ← 数据存储
├── MongoDB (新安装) ← 聊天记录
├── Python 3.9 (新安装)
└── EchoTalk 服务 (新部署)
    ├── /opt/echotalk/ ← 服务端代码
    ├── Gunicorn ← WSGI服务器
    └── Systemd ← 进程守护

微信小程序平台
└── EchoTalk 小程序 ← 客户端代码
    └── 调用服务器 API
```

---

## 最终执行命令

```bash
# 1. 上传代码到服务器
scp -r /path/to/EchoTalk root@你的服务器IP:/root/

# 2. SSH 连接服务器并执行部署
ssh root@你的服务器IP
cd /root/EchoTalk
sudo bash deploy/deploy-lite.sh

# 3. 配置密钥
vim /opt/echotalk/.env
# 修改 WECHAT_APPID, WECHAT_SECRET, ALIYUN_API_KEY

# 4. 重启服务
systemctl restart echotalk

# 5. 验证
curl http://localhost/health
```

---

## 客户端配置（微信小程序开发者工具）

1. 修改 `client/app.js` 中的 `baseUrl` 为服务器地址
2. 在微信开发者工具中上传代码
3. 在微信公众平台提交审核（如需发布）

这样分离后，服务端独立部署在阿里云，客户端托管在微信平台，符合行业标准架构。