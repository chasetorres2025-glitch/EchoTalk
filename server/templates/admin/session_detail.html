{% extends "admin/base.html" %}

{% block title %}会话详情 - EchoTalk 管理后台{% endblock %}

{% block page_title %}会话详情{% endblock %}

{% block content %}
<!-- 会话信息 -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-chat-dots"></i> 会话信息</span>
                <div>
                    {% if session.status == 0 %}
                    <span class="badge bg-secondary">进行中</span>
                    {% elif session.status == 1 %}
                    <span class="badge bg-info">已生成文章</span>
                    {% elif session.status == 2 %}
                    <span class="badge bg-success">已完成</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <td class="text-muted" width="120">会话ID</td>
                        <td>{{ session.id }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">用户</td>
                        <td>{{ session.nickname or '未知' }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">OpenID</td>
                        <td><code>{{ session.open_id }}</code></td>
                    </tr>
                    <tr>
                        <td class="text-muted">开始时间</td>
                        <td>{{ session.start_time.strftime('%Y-%m-%d %H:%M:%S') if session.start_time else '' }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">结束时间</td>
                        <td>{{ session.end_time.strftime('%Y-%m-%d %H:%M:%S') if session.end_time else '进行中' }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">文章ID</td>
                        <td>
                            {% if session.article_id %}
                            <a href="{{ url_for('admin.article_detail', article_id=session.article_id) }}">{{ session.article_id }}</a>
                            {% else %}
                            未生成
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-gear"></i> 操作
            </div>
            <div class="card-body">
                <form action="{{ url_for('admin.delete_session', session_id=session.id) }}" method="POST" onsubmit="return confirm('确定要删除此会话吗？此操作将同时删除所有聊天记录，不可恢复。');">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-trash"></i> 删除会话
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 聊天记录 -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-chat-left-text"></i> 聊天记录 ({{ messages | length }} 条)
    </div>
    <div class="card-body">
        {% if messages %}
        <div class="chat-container">
            {% for msg in messages %}
            <div class="chat-message {{ msg.role }}">
                <div class="role">
                    {% if msg.role == 'user' %}
                    <i class="bi bi-person"></i> 用户
                    {% else %}
                    <i class="bi bi-robot"></i> AI助手
                    {% endif %}
                </div>
                <div class="content">{{ msg.content }}</div>
                {% if msg.timestamp %}
                <div class="time">{{ msg.timestamp }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center text-muted py-4">
            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
            <p class="mt-3">暂无聊天记录</p>
        </div>
        {% endif %}
    </div>
</div>

<div class="mt-4">
    <a href="{{ url_for('admin.sessions') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> 返回会话列表
    </a>
</div>
{% endblock %}
